// Generated by CoffeeScript 1.3.1
(function() {
  var MakeSync, Soda, SodaCan, Sync, buildOptions, cleanArgs, patch, soda, sodaSync, _ref;

  soda = require("soda");

  _ref = require('make-sync'), MakeSync = _ref.MakeSync, Sync = _ref.Sync;

  buildOptions = function(mode) {
    if (!(mode != null)) {
      mode = 'sync';
    }
    return {
      mode: mode,
      exclude: '*',
      include: soda.commands.concat(['session'])
    };
  };

  patch = function(browser, options) {
    if (((options != null ? options.mode : void 0) != null)) {
      MakeSync(browser, buildOptions(options.mode));
      browser.queue = null;
    }
    return browser;
  };

  sodaSync = {
    createClient: function(options) {
      return patch(soda.createClient(options), options);
    },
    createSauceClient: function(options) {
      return patch(soda.createSauceClient(options), options);
    },
    current: function() {
      return Fiber.current.soda_sync_browser;
    }
  };

  cleanArgs = function(browser, cb) {
    var _ref1;
    if (typeof browser === 'function') {
      _ref1 = [null, browser], browser = _ref1[0], cb = _ref1[1];
    }
    if ((browser != null ? browser["with"] : void 0) != null) {
      browser = browser != null ? browser["with"] : void 0;
    }
    return [browser, cb];
  };

  Soda = function(browser, cb) {
    var _ref1;
    _ref1 = cleanArgs(browser, cb), browser = _ref1[0], cb = _ref1[1];
    if (cb != null) {
      Sync(function() {
        Fiber.current.soda_sync_browser = browser;
        return cb.apply(browser, []);
      });
    }
    if (browser) {
      return function(browser2, cb2) {
        var _ref2;
        _ref2 = cleanArgs(browser2, cb2), browser2 = _ref2[0], cb2 = _ref2[1];
        if (!(browser2 != null)) {
          browser2 = browser;
        }
        return Soda({
          "with": browser2
        }, cb2);
      };
    }
  };

  SodaCan = function(browser, cb) {
    var _ref1;
    _ref1 = cleanArgs(browser, cb), browser = _ref1[0], cb = _ref1[1];
    if (cb != null) {
      return function(done) {
        return Sync(function() {
          Fiber.current.soda_sync_browser = typeof browser === "function" ? browser() : void 0;
          cb.apply(typeof browser === "function" ? browser() : void 0, []);
          if (done != null) {
            return done();
          }
        });
      };
    }
    if (browser) {
      return function(browser2, cb2) {
        var _ref2;
        _ref2 = cleanArgs(browser2, cb2), browser2 = _ref2[0], cb2 = _ref2[1];
        if (!(browser2 != null)) {
          browser2 = browser;
        }
        return SodaCan({
          "with": browser2
        }, cb2);
      };
    }
  };

  exports.Soda = Soda;

  exports.SodaCan = SodaCan;

  exports.soda = sodaSync;

}).call(this);
